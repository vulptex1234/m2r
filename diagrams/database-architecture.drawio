<mxfile host="app.diagrams.net" agent="Claude Code" version="24.0.0">
  <diagram name="Database Architecture" id="database-arch">
    <mxGraphModel dx="1422" dy="1200" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1200">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Title -->
        <mxCell id="title" value="Database Architecture - PostgreSQL (Render)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=20;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="350" y="20" width="700" height="40" as="geometry"/>
        </mxCell>

        <!-- Connection Info -->
        <mxCell id="connection-info" value="&lt;b&gt;接続情報&lt;/b&gt;&lt;br&gt;&lt;br&gt;• DATABASE_URL: postgres://user:pass@host:5432/dbname&lt;br&gt;• PGSSLMODE: require (SSL必須)&lt;br&gt;• Connection Pool: pg.Pool (Node.js)&lt;br&gt;• Max Connections: 10 (デフォルト)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=12;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="80" y="80" width="600" height="100" as="geometry"/>
        </mxCell>

        <!-- Table Groups -->
        <mxCell id="group1" value="&lt;b&gt;ESP32関連テーブル&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=14;align=center;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="80" y="220" width="400" height="300" as="geometry"/>
        </mxCell>

        <mxCell id="table-device" value="&lt;b&gt;device_measurements&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt; ESP32からの生データ保存&lt;br&gt;&lt;br&gt;&lt;b&gt;書き込み頻度:&lt;/b&gt; 60s〜600s (動的)&lt;br&gt;&lt;b&gt;データ保持期間:&lt;/b&gt; 無制限 (手動削除)&lt;br&gt;&lt;br&gt;&lt;b&gt;主要クエリ:&lt;/b&gt;&lt;br&gt;• INSERT (POST /api/measurements)&lt;br&gt;• SELECT with LIMIT&lt;br&gt;&lt;br&gt;&lt;b&gt;インデックス:&lt;/b&gt; なし&lt;br&gt;(created_at でソートする場合追加推奨)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="100" y="260" width="360" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="group2" value="&lt;b&gt;レート判定関連テーブル&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=14;align=center;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="520" y="220" width="800" height="300" as="geometry"/>
        </mxCell>

        <mxCell id="table-processed" value="&lt;b&gt;processed_measurements&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt; レート判定後の処理結果&lt;br&gt;&lt;br&gt;&lt;b&gt;書き込み頻度:&lt;/b&gt; ESP32送信時 (60s〜600s)&lt;br&gt;&lt;b&gt;データ保持期間:&lt;/b&gt; 無制限&lt;br&gt;&lt;br&gt;&lt;b&gt;主要クエリ:&lt;/b&gt;&lt;br&gt;• INSERT (processMeasurementWithRating)&lt;br&gt;• SELECT ORDER BY recorded_at DESC&lt;br&gt;&lt;br&gt;&lt;b&gt;インデックス:&lt;/b&gt;&lt;br&gt;• idx_processed_measurements_recorded_at&lt;br&gt;  (recorded_at DESC)&lt;br&gt;&lt;br&gt;&lt;b&gt;パフォーマンス:&lt;/b&gt;&lt;br&gt;時系列クエリで高速化" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="540" y="260" width="240" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="table-control" value="&lt;b&gt;control_states&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt; デバイスごとの現在状態&lt;br&gt;&lt;br&gt;&lt;b&gt;書き込み頻度:&lt;/b&gt; UPSERT (毎回)&lt;br&gt;&lt;b&gt;レコード数:&lt;/b&gt; デバイス数分のみ&lt;br&gt;&lt;br&gt;&lt;b&gt;主要クエリ:&lt;/b&gt;&lt;br&gt;• UPSERT (ON CONFLICT)&lt;br&gt;• SELECT BY node_id&lt;br&gt;&lt;br&gt;&lt;b&gt;インデックス:&lt;/b&gt;&lt;br&gt;• PRIMARY KEY (node_id)&lt;br&gt;&lt;br&gt;&lt;b&gt;パフォーマンス:&lt;/b&gt;&lt;br&gt;小規模テーブル、高速" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="800" y="260" width="240" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="table-score" value="&lt;b&gt;score_logs&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt; スコア計算履歴&lt;br&gt;&lt;br&gt;&lt;b&gt;書き込み頻度:&lt;/b&gt; 毎回&lt;br&gt;&lt;b&gt;データ保持期間:&lt;/b&gt; 無制限&lt;br&gt;&lt;br&gt;&lt;b&gt;主要クエリ:&lt;/b&gt;&lt;br&gt;• INSERT&lt;br&gt;• SELECT with LIMIT&lt;br&gt;&lt;br&gt;&lt;b&gt;インデックス:&lt;/b&gt; なし&lt;br&gt;(created_at 追加推奨)&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt;&lt;br&gt;デバッグ・分析用" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="1060" y="260" width="240" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="group3" value="&lt;b&gt;天気データ関連テーブル&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;align=center;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="80" y="560" width="800" height="300" as="geometry"/>
        </mxCell>

        <mxCell id="table-forecast" value="&lt;b&gt;forecast_snapshots&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt; 予測データスナップショット&lt;br&gt;&lt;br&gt;&lt;b&gt;書き込み頻度:&lt;/b&gt; 毎時0分 (Cron Job)&lt;br&gt;&lt;b&gt;データ保持期間:&lt;/b&gt; 7日間 (自動削除)&lt;br&gt;&lt;br&gt;&lt;b&gt;主要クエリ:&lt;/b&gt;&lt;br&gt;• INSERT (Cron Job)&lt;br&gt;• SELECT ORDER BY fetched_at DESC&lt;br&gt;• DELETE WHERE fetched_at &lt; NOW() - INTERVAL '7 days'&lt;br&gt;&lt;br&gt;&lt;b&gt;JSONB構造:&lt;/b&gt;&lt;br&gt;{&lt;br&gt;  forecastC: 23.5,&lt;br&gt;  forecastTime: &quot;2025-01-10T12:00:00Z&quot;,&lt;br&gt;  fullForecast: [40個の予測データ]&lt;br&gt;}&lt;br&gt;&lt;br&gt;&lt;b&gt;インデックス:&lt;/b&gt; なし&lt;br&gt;(fetched_at 追加推奨)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="100" y="600" width="240" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="table-weather-history" value="&lt;b&gt;weather_history&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt; 過去の天気データ (時間単位)&lt;br&gt;&lt;br&gt;&lt;b&gt;書き込み頻度:&lt;/b&gt; 日次22:00 UTC&lt;br&gt;&lt;b&gt;データ保持期間:&lt;/b&gt; 無制限&lt;br&gt;&lt;br&gt;&lt;b&gt;主要クエリ:&lt;/b&gt;&lt;br&gt;• INSERT ON CONFLICT DO NOTHING&lt;br&gt;• SELECT WHERE date = $1&lt;br&gt;&lt;br&gt;&lt;b&gt;PRIMARY KEY:&lt;/b&gt;&lt;br&gt;(date, hour) - 複合キー&lt;br&gt;&lt;br&gt;&lt;b&gt;JSONB構造:&lt;/b&gt;&lt;br&gt;{&lt;br&gt;  temperature: 23.5,&lt;br&gt;  humidity: 45,&lt;br&gt;  pressure: 1013,&lt;br&gt;  weather_description: &quot;晴れ&quot;&lt;br&gt;}" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="360" y="600" width="240" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="table-daily-summary" value="&lt;b&gt;weather_daily_summary&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt; 日次天気サマリー&lt;br&gt;&lt;br&gt;&lt;b&gt;書き込み頻度:&lt;/b&gt; 日次 (計算後)&lt;br&gt;&lt;b&gt;データ保持期間:&lt;/b&gt; 無制限&lt;br&gt;&lt;br&gt;&lt;b&gt;主要クエリ:&lt;/b&gt;&lt;br&gt;• INSERT / UPDATE&lt;br&gt;• SELECT BY date&lt;br&gt;&lt;br&gt;&lt;b&gt;JSONB構造:&lt;/b&gt;&lt;br&gt;{&lt;br&gt;  min_temp: 18.5,&lt;br&gt;  max_temp: 25.3,&lt;br&gt;  avg_temp: 21.9&lt;br&gt;}" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="620" y="600" width="240" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="group4" value="&lt;b&gt;テスト用テーブル&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=14;align=center;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="920" y="560" width="400" height="300" as="geometry"/>
        </mxCell>

        <mxCell id="table-raw" value="&lt;b&gt;raw_measurements&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt; フロントエンドからのテストデータ&lt;br&gt;&lt;br&gt;&lt;b&gt;書き込み頻度:&lt;/b&gt; 手動テスト時のみ&lt;br&gt;&lt;b&gt;データ保持期間:&lt;/b&gt; 無制限 (手動削除)&lt;br&gt;&lt;br&gt;&lt;b&gt;主要クエリ:&lt;/b&gt;&lt;br&gt;• INSERT (テストデータ生成)&lt;br&gt;• SELECT ORDER BY received_at DESC&lt;br&gt;• DELETE BY id&lt;br&gt;&lt;br&gt;&lt;b&gt;インデックス:&lt;/b&gt;&lt;br&gt;• idx_raw_measurements_received_at&lt;br&gt;  (received_at DESC)&lt;br&gt;&lt;br&gt;&lt;b&gt;用途:&lt;/b&gt;&lt;br&gt;開発・デバッグ用" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=11;align=left;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="940" y="600" width="360" height="240" as="geometry"/>
        </mxCell>

        <!-- Performance Considerations -->
        <mxCell id="perf-container" value="&lt;b&gt;パフォーマンス考慮事項&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=14;align=center;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="80" y="900" width="640" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="perf-content" value="&lt;b&gt;インデックス戦略:&lt;/b&gt;&lt;br&gt;• 時系列クエリが多いテーブルには recorded_at / created_at にインデックス&lt;br&gt;• JSONB列にはGINインデックス検討 (フィルタ条件が多い場合)&lt;br&gt;&lt;br&gt;&lt;b&gt;データ保持ポリシー:&lt;/b&gt;&lt;br&gt;• forecast_snapshots: 7日間 (自動削除)&lt;br&gt;• その他: 無制限 (手動削除またはパーティショニング検討)&lt;br&gt;&lt;br&gt;&lt;b&gt;接続プール:&lt;/b&gt;&lt;br&gt;• pg.Pool で接続再利用&lt;br&gt;• Max connections: 10 (Render Free Plan制限)&lt;br&gt;&lt;br&gt;&lt;b&gt;JSONB vs 正規化:&lt;/b&gt;&lt;br&gt;• 予測データ (40個): JSONB で柔軟性確保&lt;br&gt;• 構造化データ: 通常のカラムで高速化&lt;br&gt;&lt;br&gt;&lt;b&gt;バックアップ:&lt;/b&gt;&lt;br&gt;• Render自動バックアップ (有料プラン)&lt;br&gt;• 手動エクスポート: pg_dump" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="100" y="940" width="600" height="190" as="geometry"/>
        </mxCell>

        <!-- Query Patterns -->
        <mxCell id="query-container" value="&lt;b&gt;主要クエリパターン&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;align=center;verticalAlign=top;" vertex="1" parent="1">
          <mxGeometry x="760" y="900" width="560" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="query-content" value="&lt;b&gt;1. 最新N件取得 (時系列):&lt;/b&gt;&lt;br&gt;SELECT * FROM processed_measurements&lt;br&gt;ORDER BY recorded_at DESC LIMIT 100;&lt;br&gt;&lt;br&gt;&lt;b&gt;2. デバイス状態取得:&lt;/b&gt;&lt;br&gt;SELECT * FROM control_states WHERE node_id = $1;&lt;br&gt;&lt;br&gt;&lt;b&gt;3. 予測スナップショット検索:&lt;/b&gt;&lt;br&gt;SELECT * FROM forecast_snapshots&lt;br&gt;WHERE fetched_at &lt;= $1&lt;br&gt;ORDER BY fetched_at DESC LIMIT 10;&lt;br&gt;&lt;br&gt;&lt;b&gt;4. 日次天気取得:&lt;/b&gt;&lt;br&gt;SELECT * FROM weather_history&lt;br&gt;WHERE date = $1 ORDER BY hour;&lt;br&gt;&lt;br&gt;&lt;b&gt;5. UPSERT (制御状態):&lt;/b&gt;&lt;br&gt;INSERT INTO control_states (node_id, ...)&lt;br&gt;VALUES ($1, ...) ON CONFLICT (node_id)&lt;br&gt;DO UPDATE SET ...;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=11;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="780" y="940" width="520" height="190" as="geometry"/>
        </mxCell>

        <!-- Maintenance -->
        <mxCell id="maint-section" value="&lt;b&gt;メンテナンス&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;b&gt;定期クリーンアップ:&lt;/b&gt;&lt;br&gt;DELETE FROM forecast_snapshots WHERE fetched_at &lt; NOW() - INTERVAL '7 days';&lt;br&gt;&lt;br&gt;&lt;b&gt;手動削除API:&lt;/b&gt;&lt;br&gt;• DELETE /api/measurements (device_measurements削除)&lt;br&gt;• DELETE /api/historical (weather_history削除)&lt;br&gt;• DELETE /api/all-data (全テーブル削除)&lt;br&gt;&lt;br&gt;&lt;b&gt;インデックス再構築:&lt;/b&gt;&lt;br&gt;REINDEX TABLE processed_measurements;&lt;br&gt;&lt;br&gt;&lt;b&gt;統計更新:&lt;/b&gt;&lt;br&gt;ANALYZE processed_measurements;" style="text;html=1;strokeColor=#d6b656;fillColor=#fff2cc;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=11;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="80" y="1180" width="1240" height="180" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
